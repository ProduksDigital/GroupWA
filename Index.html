<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Contact Extractor Pro + Group Label</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #25d366;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .editable-cell:focus {
            background-color: #f0fdf4;
            outline: 2px solid #22c55e;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-100">
        <!-- Header -->
        <div class="bg-slate-900 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <span class="bg-green-500 p-1.5 rounded-lg text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                    </span>
                    Contact Extractor <span class="text-green-400">AI</span>
                </h1>
                <p class="text-slate-400 text-xs mt-1">Ekstrak nomor dari screenshot dengan label grup otomatis.</p>
            </div>
            <div id="stats" class="hidden text-right">
                <div class="text-2xl font-bold text-green-400" id="statCount">0</div>
                <div class="text-[10px] uppercase tracking-wider text-slate-500">Kontak</div>
            </div>
        </div>

        <div class="p-6 space-y-6">
            <!-- Group Name / Label Option -->
            <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                <label class="block text-sm font-bold text-green-800 mb-2">Nama Grup / Label (Opsional)</label>
                <input type="text" id="groupLabel" placeholder="Contoh: Alumni SMA, Reseller Hijab, dll." class="w-full px-4 py-3 rounded-lg border border-green-200 focus:ring-2 focus:ring-green-500 outline-none transition-all">
                <p class="text-[10px] text-green-600 mt-2 italic">*Jika diisi, nama kontak akan otomatis diawali label ini (misal: Alumni SMA - Budi)</p>
            </div>

            <!-- Upload Section -->
            <div id="uploadArea" class="group border-2 border-dashed border-gray-200 rounded-2xl p-8 text-center hover:border-green-500 hover:bg-green-50/30 transition-all cursor-pointer relative overflow-hidden">
                <input type="file" id="imageInput" accept="image/*" class="hidden">
                <div id="previewContainer" class="hidden mb-4 relative z-10">
                    <img id="imagePreview" class="max-h-48 mx-auto rounded-lg shadow-lg border-4 border-white">
                    <button id="changeImgBtn" class="mt-3 text-xs text-red-500 font-semibold hover:underline">Ganti Gambar</button>
                </div>
                <div id="uploadPlaceholder" class="relative z-10">
                    <div class="bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <svg class="h-8 w-8 text-gray-400 group-hover:text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </div>
                    <p class="text-gray-600 font-medium">Klik untuk pilih Screenshot Grup WA</p>
                </div>
            </div>

            <!-- Action Button -->
            <button id="processBtn" disabled class="w-full py-4 bg-green-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-green-700 disabled:bg-gray-200 disabled:text-gray-400 transition-all flex justify-center items-center gap-3">
                Ekstrak Sekarang
            </button>

            <!-- Loading State -->
            <div id="loadingState" class="hidden flex flex-col items-center py-10">
                <div class="loading-spinner mb-4"></div>
                <p class="text-slate-600 font-medium animate-pulse text-center">AI sedang memindai nama & nomor...</p>
            </div>

            <!-- Result Area -->
            <div id="resultArea" class="hidden space-y-4 pt-4 border-t">
                <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center">
                    <div class="relative w-full md:w-64">
                        <input type="text" id="searchInput" placeholder="Cari data..." class="w-full pl-9 pr-4 py-2 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none">
                        <svg class="w-4 h-4 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <button onclick="downloadCSV()" class="w-full md:w-auto bg-slate-800 text-white px-6 py-2.5 rounded-lg text-sm font-bold hover:bg-black transition-all flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        Download Excel (CSV)
                    </button>
                </div>

                <div class="overflow-x-auto border border-gray-200 rounded-xl shadow-inner bg-white">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 border-b border-gray-200">
                            <tr>
                                <th class="px-4 py-4 font-bold text-slate-700 w-12 text-center">No</th>
                                <th class="px-4 py-4 font-bold text-slate-700">Nama Kontak</th>
                                <th class="px-4 py-4 font-bold text-slate-700">Nomor Telepon</th>
                                <th class="px-4 py-4 font-bold text-slate-700 w-16 text-center">Hapus</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-100">
                            <!-- Data -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-xl text-sm opacity-0 transition-all shadow-2xl z-50 pointer-events-none">
        Pesan berhasil muncul!
    </div>

    <script>
        const apiKey = ""; 
        const imageInput = document.getElementById('imageInput');
        const uploadArea = document.getElementById('uploadArea');
        const preview = document.getElementById('imagePreview');
        const previewContainer = document.getElementById('previewContainer');
        const placeholder = document.getElementById('uploadPlaceholder');
        const processBtn = document.getElementById('processBtn');
        const loadingState = document.getElementById('loadingState');
        const resultArea = document.getElementById('resultArea');
        const tableBody = document.getElementById('tableBody');
        const searchInput = document.getElementById('searchInput');
        const groupLabelInput = document.getElementById('groupLabel');
        const changeImgBtn = document.getElementById('changeImgBtn');

        let extractedData = [];
        let filteredData = [];

        uploadArea.onclick = (e) => { if (e.target !== changeImgBtn) imageInput.click(); };
        changeImgBtn.onclick = (e) => { e.stopPropagation(); imageInput.click(); };

        imageInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    preview.src = event.target.result;
                    previewContainer.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    processBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        };

        processBtn.onclick = async () => {
            const base64Data = preview.src.split(',')[1];
            loadingState.classList.remove('hidden');
            processBtn.classList.add('hidden');
            resultArea.classList.add('hidden');

            try {
                await processImageWithAI(base64Data);
            } catch (error) {
                showToast("‚ùå Gagal membaca gambar.");
            } finally {
                loadingState.classList.add('hidden');
                processBtn.classList.remove('hidden');
            }
        };

        async function processImageWithAI(base64Image) {
            const prompt = `Analisis screenshot WA ini. Ambil daftar Nama dan Nomor HP.
            PENTING: Jika hanya ada nomor tanpa nama, beri nama "Member".
            JSON Format: { "contacts": [{ "name": "...", "phone": "..." }] }`;

            let attempts = 0;
            const maxRetries = 5;

            while (attempts < maxRetries) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: "image/png", data: base64Image } } ] }],
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "OBJECT",
                                    properties: {
                                        contacts: {
                                            type: "ARRAY",
                                            items: {
                                                type: "OBJECT",
                                                properties: {
                                                    name: { type: "STRING" },
                                                    phone: { type: "STRING" }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        })
                    });

                    if (!response.ok) throw new Error('API Error');

                    const result = await response.json();
                    const jsonResponse = JSON.parse(result.candidates[0].content.parts[0].text);
                    extractedData = jsonResponse.contacts;
                    filteredData = [...extractedData];
                    
                    document.getElementById('stats').classList.remove('hidden');
                    document.getElementById('statCount').innerText = extractedData.length;
                    
                    renderTable(filteredData);
                    showToast(`‚úÖ Ditemukan ${extractedData.length} kontak`);
                    return;
                } catch (error) {
                    attempts++;
                    await new Promise(r => setTimeout(r, Math.pow(2, attempts) * 500));
                }
            }
        }

        function renderTable(data) {
            tableBody.innerHTML = '';
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-50";
                row.innerHTML = `
                    <td class="px-4 py-4 text-gray-400 text-center">${index + 1}</td>
                    <td class="px-4 py-4">
                        <div contenteditable="true" class="editable-cell px-2 py-1 font-medium text-slate-800" onblur="updateData(${index}, 'name', this.innerText)">${item.name}</div>
                    </td>
                    <td class="px-4 py-4">
                        <div contenteditable="true" class="editable-cell px-2 py-1 font-mono text-green-700" onblur="updateData(${index}, 'phone', this.innerText)">${item.phone}</div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <button onclick="deleteRow(${index})" class="text-red-400 hover:text-red-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            resultArea.classList.remove('hidden');
        }

        searchInput.oninput = (e) => {
            const term = e.target.value.toLowerCase();
            filteredData = extractedData.filter(item => 
                item.name.toLowerCase().includes(term) || item.phone.toLowerCase().includes(term)
            );
            renderTable(filteredData);
        };

        function updateData(index, field, value) { extractedData[index][field] = value.trim(); }
        function deleteRow(index) {
            extractedData.splice(index, 1);
            filteredData = [...extractedData];
            document.getElementById('statCount').innerText = extractedData.length;
            renderTable(filteredData);
        }

        function downloadCSV() {
            if (extractedData.length === 0) return;
            const label = groupLabelInput.value.trim();
            
            let csvContent = "\uFEFFName,Phone Number\r\n";
            extractedData.forEach(item => {
                // Tambahkan label jika ada
                const finalName = label ? `${label} - ${item.name}` : item.name;
                csvContent += `"${finalName.replace(/"/g, '""')}","${item.phone.replace(/"/g, '""')}"\r\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Kontak_${label || 'Group'}_${new Date().getTime()}.csv`;
            link.click();
            showToast("üìÇ File Excel berhasil diunduh!");
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 3000);
        }
    </script>
</body>
</html>
